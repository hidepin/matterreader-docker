matterreader-docker
============================================================

要求条件
------------------------------------------------------------
- docker
- docker-compose

mattermost設定
------------------------------------------------------------

- WebHookを有効化する(システム管理者)

  1. 左上のメニューから「システムコンソール」を押下する

  2. 「設定」->「統合機能」->「ウェブフックとコマンド」を押下し、下記を設定する

    |メニュー                                                         |設定値|
    |:-------------------------------------------------- ------------|:----|
    |外向きのウェブフックを有効化する                                       |有効 |
    |外向きのウェブフックを有効化する                                       |有効 |
    |ウェブフックまたはスラッシュコマンドでのユーザー名を上書きする                |有効 |
    |プロフィールの画像アイコンを上書きするウェブフックとスラッシュコマンドを有効にする|有効 |

- botからmattermostへのアクセス設定(チーム管理者/システム管理者)

  1. 左上のメニューから「統合機能」を押下する

  2. 「内向きのウェブフック」->「内向きのウェブフックを追加する」を押下する

  3. 下記を設定し、「保存する」を押下する

    |メニュー    |設定値                           |
    |:-----------|:--------------------------------|
    |Display Name|(任意)                           |
    |説明        |(任意)                           |
    |チャネル    |(botを動作させたいチャネルを指定)|

- mattermostからbotへのアクセス設定(チーム管理者/システム管理者)

  1. 左上のメニューから「統合機能」を押下する

  2. 「外向きのウェブフック」->「外向きのウェブフックを追加する」を押下する

  3. 下記を設定し、「保存する」を押下する

    |メニュー                     |設定値                                           |
    |:----------------------------|:------------------------------------------------|
    |Display Name                 |(任意)                                           |
    |説明                         |(任意)                                           |
    |チャネル                     |(botを動作させたいチャネルを指定)                |
    |コールバックURL(1つにつき1行)|http://(botのサーバ):(botのポート)/hubot/incoming|

bot設定
------------------------------------------------------------

docker-compose.ymlファイルの下記パラメータを環境に合わせ変更する

- MATTERMOST_HUBOT_USERNAME=(表示したいbot名称)
- MATTERMOST_INCOME_URL=(内向きのウェブフックのURL)
- MATTERMOST_TOKEN=(外向きのウェブフックのトークン(複数ある場合はカンマで区切り入力))

起動方法
------------------------------------------------------------

1. ディレクトリに移動する

  ``` shell
  cd matterreader-docker
  ```

2. ディレクトリを作成する

  ``` shell
  mkdir -p ../volumes/app/home/hubot/matterreader/data
  chmod 0777 ../volumes/app/home/hubot/matterreader/data
  ```

2. 起動する

  - 2回目以降
    ``` shell
    docker-compose start
    ```

  - 初回
    ``` shell
    docker-compose up -d
    ```

3. 起動状態を確認する

  ``` shell
  docker-compose ps
  ```

停止方法
------------------------------------------------------------

1. ディレクトリに移動する

  ``` shell
  cd matterreader-docker
  ```

2. 起動状態を確認する

  ``` shell
  docker-compose ps
  ```

3. 停止する

  ``` shell
  docker-compose stop
  ```

4. 停止状態を確認する

  ``` shell
  docker-compose ps
  ```

systemdによる自動起動設定
------------------------------------------------------------
host OSにsystemdの自動起動設定を行う
(ansibleのdocker imageが必要)

1. host OSにログインする

2. dockerからansibleの設定を行う

  ``` shell
  docker run --rm -it -v $(pwd)/systemd:/playbook hidepin/ansible ansible-playbook -i "(host OSのIPアドレス)," systemd.yml
  ```
